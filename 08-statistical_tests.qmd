# Tilastollinen testaaminen {#sec-tests}

## Testaamisen periaatteita

Tilastollisilla testeillä pyritään arvioimaan perusjoukkoa koskevien väiteiden paikkansapitävyyttä todennäköisyyslaskennan keinoin. Lähtökohtana on niin sanottu **nollahypoteesi** ($H_0$), joka yleensä vastaa tilannetta, jossa mahdolliset väitettä tukevat haivainnot ovat vain sattuman seurausta. Esimerkiksi jos tutkitaan onko jokin lääkeaine tehokas hoitokeino, voisi nollahypoteesi olla muotoa "lääkeaineella ei ole vaikutusta". Nollahypoteesiin liittyy aina **vastahypoteesi** ($H_1$), joka yleensä nollahypoteesin vastakohta, ja vastaa mielenkiinnon kohteena olevaa väitettä (esim. "lääkeaineella on vaikutusta").

Tilastolliset testit olettava nollahypoteesin olevan totta, jolloin nollahypoteesin mielessä erittäin harvinaiset tulokset antavat aihetta epäillä nollahypoteesin mielekkyyttä. Testiin liittyy yleensä **testisuure**, joka on jokin aineistosta laskettu tunnusluku. Testisuureen jakauman perusteella voidaan arvioida todennäköisyyttä, että havaittu tulos olisi vain sattuman seurausta. Tätä todennäköisyyttä kutsutaan **p-arvoksi**. Perinteisesti tilastotieteessä asetetaan etukäteen jokin merkitsevyystaso (significance level, $\alpha$), ja jos saatu p-arvo on merkitsevyystasoa pienempi niin nollahypoteesi hylätään (yleensä $\alpha = 0.05$). Jos p-arvo on merkitsevyystaso pienempi, niin havaintoa kutsutaan tilastollisesti merkitseväksi (nykyisin suositellaan myös termiä "tilastollisesti erottuva", sillä sana "merkitsevä" menee usein sekaisin sanan "merkittävä" kanssa).

## $t$-testi

Studentin $t$-testi on yksi tunnetuimmista tilastollisista testeistä. Se testaa yhden tai kahden ryhmän odotusarvoja tietylle muuttujalle.

Tarkastellaan R:n sisäistä dataa `sleep`, joka sisältää mittauksia muutoksista oppilaiden unen määrässä (muuttuja `extra`, muutos unen määrässä tunneissa) kahdella eri lääkkeellä (muuttuja `group`). Jokainen oppilas kokeili kumpaakin lääkettä, muuttuja `ID` yksilöi oppilaat.

### Yhden otoksen $t$-testi

Testaamme aluksi hypoteesia, että muutos unen määrässä lääkkeen käytön jälkeen on 0 ($H_0 : \mu = 0$). Funktiota `t.test` voi käyttää monella tapaa. Tässä esimerkissä annamme funktiolle kaavan `extra ~ 1`, eli ns. `formula`-objektin ensimmäisenä argumenttina, joka on osa R:n syntaksia tilastollisten mallien ja riippuvuusrakenteiden määrittellyyn. Kaava määrittelee, että `~`-merkin vasen puoli on vastemuuttuja, ja oikea puoli sisältää selittävät muuttujat. Koska emme tee testiä minkään toisen muuttujan suhteen, niin kaavan oikean puoli on vain luku 1, joka R:n syntaksissa tarkoittaa, että se on vakio. Tämä ei siis tarkoita esimerkiksi sitä, että nollahypoteesimme olisi, että muutos unen määrässä olisi 1 tunti. Nollahypoteesin mukainen odotusarvo määritellään argumentilla `mu`, joka yhden otoksen testissä saa oletusarvon 0.
```{r}
# One sample test
tt1 <- t.test(extra ~ 1, data = sleep)
tt1
```
Tuloksena saamme $t$-testisuureen arvon, vapausasteet sekä testin p-arvon. Koska p-arvo on pieni (perinteisesti rajana käytetään lukua 0.05, mutta tämä vaihtelee tieteenalasta riippuen) niin nollahypoteesi hylätään, eli testin mukaan muutos unen määrässä poikkeaa tilastollisesti merkitsevästi nollasta kumpaa tahansa lääkettä käytettäessä. Tuloste kertoo myös testin vastahypoteesin $H_1$ kohdassa "alternative hypothesis". 

Testiin liittyvät tunnusluvut (testisuure, vapausasteet ja p-arvo) saamme eriteltyä tulosobjektista `tt1` seuraavasti:
```{r}
# Test statistic
tt1$statistic
# Degrees of freedom
tt1$parameter
# p-value
tt1$p.value
```

### Kahden otoksen $t$-testi

Entäpä jos haluammekin testata hypoteesia, että kumpikin lääke vaikuttaa samalla tavalla unen määrään ($H_0 : \mu_1 = \mu_2$)? Voimme tässäkin tapauksessa käyttää `formula`-syntaksia hyödyksi. Vakion 1 sijaan sijoitamme nyt lääkettä vastaavan muuttujan `group` kaavassa `~`-merkin oikealle puolelle.
```{r}
tt2 <- t.test(extra ~ group, data = sleep)
tt2
```

Testiobjektin sisältö vastaa yhden otoksen testiä suurimmilta osin. Näämme, että testin tulos ei tällä kertaa ollut tilastollisesti merkitsevä (merkitsevyystasolla 0.05) eli testin mukaan ei ole näyttöä siitä, että lääkkeet vaikuttaisivat eri tavalla unen määrään, jolloin nollahypoteesia ei hylätä. 

Tarkkasilmäinen lukija saattoi kuitenkin huomata, että tämä testi ei aivan vastaa tarkoitusta, sillä `sleep`-aineistossa jokainen koehenkilö kokeili kumpaakin lääkettä, jolloin oikea tapa olisi testata lääkkeiden vaikutuksen erotusta, sillä mittaukset ovat toisistaan riippuvia. Tehdään tämä seuraavaksi.

### Riippuvien (parittaisten) otosten $t$-testi

Jotta mittausparit tulevat otettua huomioon testissä, on `t.test`-funktiolle annettava argumentti `paired = TRUE`. Tässä testissä nollahypoteesi on, että lääkkeiden vaikutuksen erotuksen odotusarvo on 0 ($H_0 : \mu_d = 0$). Uudemmilla R-versioilla `formula`-syntaksia ei voi enää käyttää kun kyseessä on parittainen testi, joten mittauspareja vastaavat arvot on poimittava käsin.
```{r}
tt3 <- t.test(
  sleep$extra[sleep$group == 1],
  sleep$extra[sleep$group == 2],
  data = sleep, 
  paired = TRUE
)
tt3
```
Tällä kertaa tulos on taas tilastollisesti merkitsevä (p-arvo on noin `r round(tt3$p.value, 3)`), eli lääkkeiden vaikutuksessa unen määrään on tilastollisesti merkitsevä ero, jolloin nollahypoteesi hylätään.


## Khiin neliö -testi {#sec-chi}

Kahden kategorisen muuttujan riippuvuuden tutkimiseen voidaan käyttää khiin neliö -testiä ($\chi^2$ test). Tyypillisesti halutaan verrata jonkin muuttujan ryhmien välisiä eroja, kuten puoluekannatusta alueittain tai sukupuolten suhteen. Testin ideana on verrata havaittua ristitaulukkoa nollahypoteesin mukaiseen ristitaulukkoon, jossa muuttujien välillä ei ole lainkaan riippuvuutta. Khiin neliö -testin testisuure perustuu näiden kahden taulukon eroihin.

Tarkastellaan Yhdysvaltalaista kyselytutkimusaineistoa, joka sisältää tiedon henkilön puoluekannatuksesta ja sukupuolesta. Tutkitaan khiin neliö -testin avulla, riippuuko puoluekannatus sukupuolesta. R:ssä tämä voidaan tehdä funktiolla `chisq.test`.

```{r}
## From Agresti(2007) p.39
M <- as.table(rbind(c(762L, 327L, 468L), c(484L, 239L, 477L)))
dimnames(M) <- list(
  gender = c("F", "M"),
  party = c("Democrat", "Independent", "Republican")
)
(Xsq <- chisq.test(M))  # Prints test summary
Xsq$observed   # observed counts (same as M)
Xsq$expected   # expected counts under the null
Xsq$residuals  # Pearson residuals
Xsq$stdres     # standardized residuals
```

Koska testin p-arvo on pieni, niin nollahypoteesi hylätään ja todetaan, että puoluekannatus riippuu tilastollisesti merkitsevästi sukupuolesta. Testin luotettavuuden kannalta on kuitenkin hyvä huomioida, että testiin liittyy oletuksia, jotka koskevat odotettuja frekvenssejä (eli nollahypoteesin mukaisen ristitaulukon frekvenssejä). Tyypillisesti vaaditaan, että odotetun frekvenssin on oltava vähintään 5 vähintään 80%:ssa taulukon soluista, eikä yhdenkään solun odotettu frekvenssi ole alle 1. Tarkistetaan oletukset edellisen esimerkin tapauksessa, odotetut frekvenssit löytyvät testiobjektin alkiosta `expected`:
```{r}
all(Xsq$expected >= 1)
mean(Xsq$expected >= 5) >= 0.80
```
Oletukset ovat tältä osin kunnossa. Edellä funktio `all` ottaa syötteenään loogisen vektorin ja palauttaa `TRUE` jos syötteen kaikki alkiot ovat `TRUE`. Muutoin funktio palauttaa `FALSE`. Voisimme myös laskea odotetut frekvenssit seuraavalla tavalla suoraan taulukosta ennen testin tekemistä:
```{r}
rowSums(M) %*% t(colSums(M)) / sum(M)
```
Toisin sanoen, kerromme jokaisen rivisumman vastaavalla sarakesummalla ja jaamme lopputuloksen havaintojen määrällä.

Edellisessä esimerkissä ristitaulukko oli valmiiksi rakennettu annetuista frekvensseistä. Ristitaulukko voitaisiin myös rakentaa yksilötason aineistosta, esimerkiksi datakehikosta, joka sisältää rivin jokaista kyselyyn vastannutta henkilöä kohden ja tiedon vastaajan ilmoittamasta puolueesta ja sukupuolesta. Seuraavassa esimerkissä kyselytutkimusaineisto on muuttujassa `poll_data`, joka voidaan muuntaa ristitauloksi funktiolla `table`. Huomataan, että tällä tavalla muodostettu ristitaulukko on sama kuin suoraan frekvensseistä koottu taulukko.
```{r, echo=FALSE, eval=TRUE}
poll_data <- as.data.frame.table(M)
poll_data <- poll_data[rep(seq_len(nrow(poll_data)), poll_data$Freq), -3L]
rownames(poll_data) <- seq_len(nrow(poll_data))
```
```{r}
head(poll_data)
nrow(poll_data)
# The cross tabulations are the same
identical(M, table(poll_data))
```


## Varianssianalyysi

Varianssianalyysin voidaan ajatella olevan $t$-testin yleistys, jossa yhden tai kahden odotusarvon sijaan verrataankin kerralla useamman ryhmän odotusarvoja keskenään. Menetelmä saa nimensä siitä, että sen testisuure perustuu kiinnostuksen kohteena olevan muuttujan kokonaisvaihtelun (varianssin) jakamiseen verratavien ryhmien sisäiseen vaihteluun ja niiden väliseen vaihteluun. Koska harjoitusaineistossa `study_data` ei vielä ole kategorista muuttujaa, jossa on vähintään kolme kategoriaa, niin luodaan sellainen.

```{r}
study_data <- read.table("data/study_data.txt")

# create a new categorical variable called age_group
# 3,5,6 => ryhmä 1
# 2,4,8 => ryhmä 2
# 1,7   => ryhmä 3
# vaste: weight
study_data$age_group <- c("3", "2", "1", "2", "1", "1", "3", "2")
study_data$fage_group <- factor(study_data$age_group)
```
Hypoteesit ovat:

- $H_0$: Ryhmien odotusarvot ovat samat tarkasteltavan muuttujan suhteen ($\mu_1 = \mu_2 = \dots = \mu_n$),
- $H_1$: Ryhmien odotusarvoissa on eroa tarkasteltavan muuttujan suhteen ($\mu_i \ne \mu_j$ ainakin joillekin $i \ne j$).
 
```{r}
# conduct Analysis of Variance (ANOVA) for study_data
# we test if averages of height differ between age groups
summary(aov(height ~ fage_group, data = study_data))
```
```{r, include=FALSE}
aov_pvalue <- summary(aov(height ~ fage_group, data = study_data))[[1]]$Pr[1]
```

Varianssianalyysin `summary` sisältää seuraavat sarakkeet: `Df` kertoo testiin liittyvän $F$-jakauman vapausasteet, `Sum Sq` kertoo ryhmiin liittyvän neliösumman ja jäännösneliösumman, `Mean Sq` kertoo vastaavan keskineliösumman, `F value` kertoo testisuureen arvon ja `Pr(>F)` kertoo testin P-arvon. Tässä tapauksessa testin p-arvo on noin `r round(aov_pvalue, 3)`, joten nollahypoteesia ei hylätä.

## Levenen testi

Levenen testillä tutkitaan ovatko jonkin muuttujan varianssit samat kahdessa tai useammassa ryhmässä. Testiä ei ole toteutettu valmiiksi R:ssä, mutta se on saatavilla Rcourse-paketin kautta funktiossa `leveneTest`. Testin nollahypoteesi on, että muuttujan varianssit ovat samat joka ryhmässä.

Selvitetään onko harjoitusaineiston `study_data` muuttujan `height` varianssissa eroa eri ikäryhmien välillä (`fage_group`) Levenen testillä.
```{r include = FALSE}
library("Rcourse")
```
```{r}
leveneTest(height ~ fage_group, data = study_data)
```
```{r, include=FALSE}
levene_pvalue <- leveneTest(height ~ fage_group, data = study_data)$Pr[1]
```
Testin p-arvo löytyy sarakkeesta `Pr(>F)`, ja se on noin `r round(levene_pvalue, 3)`. Testin mukaan muuttujan varianssit eivät eroa ryhmien välillä, ja nollahypoteesi jää voimaan. 

## Shapiro-Wilk -testi

Shapiro-Wilk -testillä tutkitaan onko jokin muuttuja normaalijakautunut. Testi löytyy funktiosta `shapiro.test`, ja se ottaa argumenttinaan yhden muuttujan havainnot vektorina. Funktiolla ei voi siis suoraan testata esimerkiksi sitä, onko muuttuja normaalijakautunut joissakin osaryhmissä, vaan aineisto on ensin jaettava sopiviin osiin. Testin nollahypoteesi on, että muuttuja on normaalijakautunut.

Tarkastellaan jälleen harjoitusaineistoa `study_data` ja testataan muuttujan `height` normaalisuutta.
```{r}
shapiro.test(study_data$height)
```
Testin p-arvon voi lukea kohdasta `p-value` ja se on tällä aineistolla hyvin lähellä nollaa, eli `height`-muuttuja ei testin mukaan ole normaalijakautunut ja nollahypoteesi hylätään.
